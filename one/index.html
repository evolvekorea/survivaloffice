<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SurvivalOffice 블로그형 게시판 - ONE</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>블로그형 게시판 - ONE</h1>
    <button id="login-btn">Google 로그인</button>
    <button id="logout-btn" style="display:none;">로그아웃</button>
    <div id="write-post" style="display:none;">
        <h2>글 작성하기</h2>
        <input type="text" id="post-title" placeholder="제목"><br>
        <div id="editor-container" style="height: 200px;"></div><br>
        <input type="file" id="image-upload" accept="image/*"><br><br>
        <button id="submit-post">게시글 작성</button>
    </div>
    <div id="posts-container"></div>
    <div id="pagination-controls"></div>

    <!-- 모달 창 구조 -->
    <div id="post-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div id="modal-post-content"></div>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script type="module">
        // Firebase SDK 모듈 가져오기
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, startAfter, deleteDoc, doc, serverTimestamp, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

        // Firebase 초기화
        const firebaseConfig = {
            apiKey: "AIzaSyBU64Ad2ywQ2rTPFk4Do-PjApjLGXaiX3w",
            authDomain: "survivaloffice-blog.firebaseapp.com",
            projectId: "survivaloffice-blog",
            storageBucket: "survivaloffice-blog.appspot.com",
            messagingSenderId: "260169940492",
            appId: "1:260169940492:web:00ffac5d2600658b85b829"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const provider = new GoogleAuthProvider();
        const loginButton = document.getElementById('login-btn');
        const logoutButton = document.getElementById('logout-btn');
        const writePostDiv = document.getElementById('write-post');
        const postsContainer = document.getElementById('posts-container');
        const submitPostButton = document.getElementById('submit-post');
        const imageUploadInput = document.getElementById('image-upload');
        const modal = document.getElementById('post-modal');
        const modalContent = document.getElementById('modal-post-content');
        const closeModalBtn = document.querySelector('.close-btn');
        const paginationControls = document.getElementById('pagination-controls');

        let lastVisible = null;
        const POSTS_PER_PAGE = 5;

        // Quill 에디터 초기화
        const quill = new Quill('#editor-container', {
            theme: 'snow'
        });

        // 로그인 기능
        loginButton.addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                if (result.user.email !== 'evolvekorea@gmail.com') {
                    alert('허용되지 않은 사용자입니다.');
                    await signOut(auth);
                } else {
                    alert('로그인 성공');
                }
            } catch (error) {
                console.error('로그인 오류:', error);
                alert(`로그인 실패: ${error.message}`);
            }
        });

        // 로그아웃 기능
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                alert('로그아웃 성공');
            } catch (error) {
                console.error('로그아웃 오류:', error);
                alert(`로그아웃 실패: ${error.message}`);
            }
        });

        // 로그인 상태 변경 감지
        onAuthStateChanged(auth, (user) => {
            if (user && user.email === 'evolvekorea@gmail.com') {
                loginButton.style.display = 'none';
                logoutButton.style.display = 'block';
                writePostDiv.style.display = 'block';
            } else {
                loginButton.style.display = 'block';
                logoutButton.style.display = 'none';
                writePostDiv.style.display = 'none';
            }
            loadPosts();
        });

        // 이미지 업로드 및 게시글 작성 기능
        submitPostButton.addEventListener('click', async () => {
            const title = document.getElementById('post-title').value.trim();
            const content = quill.root.innerHTML.trim();
            const author = auth.currentUser ? auth.currentUser.email : 'Anonymous';
            const timestamp = serverTimestamp();

            let imageUrl = '';

            if (imageUploadInput.files.length > 0) {
                const file = imageUploadInput.files[0];
                const storageRef = ref(storage, `one/${Date.now()}_${file.name}`);

                try {
                    await uploadBytes(storageRef, file);
                    imageUrl = await getDownloadURL(storageRef);
                } catch (error) {
                    console.error('이미지 업로드 오류:', error);
                    alert(`이미지 업로드 실패: ${error.message}`);
                }
            }

            if (title && content) {
                try {
                    await addDoc(collection(db, 'one'), {
                        author,
                        content,
                        likes: 0,
                        timestamp,
                        title,
                        imageUrl,
                        pinned: false
                    });
                    alert('게시글이 작성되었습니다.');
                    document.getElementById('post-title').value = '';
                    quill.root.innerHTML = '';
                    imageUploadInput.value = '';
                    loadPosts();
                } catch (error) {
                    console.error('게시글 작성 오류:', error);
                    alert(`게시글 작성 실패: ${error.message}`);
                }
            } else {
                alert('제목과 내용을 입력하세요.');
            }
        });

        // 게시글 불러오기 기능
        async function loadPosts() {
            postsContainer.innerHTML = '';
            paginationControls.innerHTML = '';
            try {
                const pinnedQuery = query(collection(db, 'one'), orderBy('timestamp', 'desc'));
                const allQuery = query(collection(db, 'one'), orderBy('timestamp', 'desc'), limit(POSTS_PER_PAGE));
                const pinnedSnapshot = await getDocs(pinnedQuery);
                const allSnapshot = await getDocs(allQuery);

                let pinnedCount = 0;

                pinnedSnapshot.forEach((doc) => {
                    const post = doc.data();
                    if (post.pinned && pinnedCount < 3) {
                        addPostToPage(doc.id, post, true);
                        pinnedCount++;
                    }
                });

                allSnapshot.forEach((doc) => {
                    const post = doc.data();
                    if (!post.pinned) {
                        addPostToPage(doc.id, post, false);
                    }
                });

                lastVisible = allSnapshot.docs[allSnapshot.docs.length - 1];

                if (allSnapshot.docs.length === POSTS_PER_PAGE) {
                    const nextPageButton = document.createElement('button');
                    nextPageButton.textContent = '다음 페이지';
                    nextPageButton.addEventListener('click', loadMorePosts);
                    paginationControls.appendChild(nextPageButton);
                }
            } catch (error) {
                console.error('게시글 불러오기 오류:', error);
                alert(`게시글 불러오기 실패: ${error.message}`);
            }
        }

        // 추가 게시글 불러오기 기능
        async function loadMorePosts() {
            try {
                const nextQuery = query(collection(db, 'one'), orderBy('timestamp', 'desc'), startAfter(lastVisible), limit(POSTS_PER_PAGE));
                const nextSnapshot = await getDocs(nextQuery);

                nextSnapshot.forEach((doc) => {
                    const post = doc.data();
                    addPostToPage(doc.id, post, false);
                });

                lastVisible = nextSnapshot.docs[nextSnapshot.docs.length - 1];

                if (nextSnapshot.docs.length < POSTS_PER_PAGE) {
                    paginationControls.innerHTML = '';
                }
            } catch (error) {
                console.error('추가 게시글 불러오기 오류:', error);
                alert(`추가 게시글 불러오기 실패: ${error.message}`);
            }
        }

        function addPostToPage(postId, post, isPinned) {
            const postDiv = document.createElement('div');
            postDiv.classList.add('post');

            let timestamp = '시간 정보 없음';
            if (post.timestamp && post.timestamp.toDate) {
                timestamp = post.timestamp.toDate().toLocaleString();
            }

            const imageTag = post.imageUrl ? `<img src="${post.imageUrl}" alt="게시글 이미지" class="post-image">` : '';

            postDiv.innerHTML = `
                <div class="post-content">
                    <div class="post-title" onclick="showModal('${postId}')">${post.title}</div>
                    <div class="post-body" id="post-body-${postId}">${post.content.substring(0, 100)}...</div>
                    <div class="post-meta">
                        <small>작성자: ${post.author} | ${timestamp}</small>
                        <button class="like-button" onclick="likePost('${postId}')">좋아요 (${post.likes})</button>
                    </div>
                </div>
            `;
            postsContainer.appendChild(postDiv);
        }

        async function likePost(postId) {
            try {
                const postRef = doc(db, 'one', postId);
                const postSnap = await getDoc(postRef);
                if (postSnap.exists()) {
                    const currentLikes = postSnap.data().likes || 0;
                    const likedPosts = JSON.parse(localStorage.getItem('likedPosts')) || [];
                    if (!likedPosts.includes(postId)) {
                        await updateDoc(postRef, { likes: currentLikes + 1 });
                        likedPosts.push(postId);
                        localStorage.setItem('likedPosts', JSON.stringify(likedPosts));
                        alert('추천했습니다.');
                        loadPosts();
                    } else {
                        alert('이미 추천한 게시글입니다.');
                    }
                }
            } catch (error) {
                console.error('좋아요 기능 오류:', error);
            }
        }

        window.showModal = async function (postId) {
            try {
                const postRef = doc(db, 'one', postId);
                const postSnap = await getDoc(postRef);

                if (postSnap.exists()) {
                    const post = postSnap.data();
                    let timestamp = '시간 정보 없음';
                    if (post.timestamp && post.timestamp.toDate) {
                        timestamp = post.timestamp.toDate().toLocaleString();
                    }

                    modalContent.innerHTML = `
                        <h2>${post.title}</h2>
                        ${post.imageUrl ? `<img src="${post.imageUrl}" alt="게시글 이미지" style="max-width: 100%; height: auto;">` : ''}
                        <div>${post.content}</div>
                        <small>작성자: ${post.author} | 좋아요: ${post.likes} | ${timestamp}</small>
                    `;
                    modal.style.display = 'block';
                }
            } catch (error) {
                console.error('모달 열기 오류:', error);
                alert(`게시글 불러오기 실패: ${error.message}`);
            }
        }

        closeModalBtn.onclick = function() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
