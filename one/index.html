<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SurvivalOffice 블로그형 게시판 - ONE</title>
    <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>블로그형 게시판 - ONE</h1>
    <button id="login-btn">Google 로그인</button>
    <button id="logout-btn" style="display:none;">로그아웃</button>
    <div id="write-post" style="display:none;">
        <h2>글 작성하기</h2>
        <input type="text" id="post-title" placeholder="제목"><br>
        <textarea id="post-content" placeholder="내용"></textarea><br>
        <button id="submit-post">게시글 작성</button>
    </div>
    <div id="posts-container"></div>

    <script>
        // Firebase 초기화
        const firebaseConfig = {
            apiKey: "AIzaSyBU64Ad2ywQ2rTPFk4Do-PjApjLGXaiX3w",
            authDomain: "survivaloffice-blog.firebaseapp.com",
            projectId: "survivaloffice-blog",
            storageBucket: "survivaloffice-blog.appspot.com",
            messagingSenderId: "260169940492",
            appId: "1:260169940492:web:00ffac5d2600658b85b829"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const provider = new firebase.auth.GoogleAuthProvider();
        const loginButton = document.getElementById('login-btn');
        const logoutButton = document.getElementById('logout-btn');
        const writePostDiv = document.getElementById('write-post');
        const postsContainer = document.getElementById('posts-container');
        const submitPostButton = document.getElementById('submit-post');

        // 로그인 기능
        loginButton.addEventListener('click', async () => {
            try {
                const result = await auth.signInWithPopup(provider);
                if (result.user.email !== 'evolvekorea@gmail.com') {
                    alert('허용되지 않은 사용자입니다.');
                    await auth.signOut();
                }
            } catch (error) {
                console.error(error);
            }
        });

        // 로그아웃 기능
        logoutButton.addEventListener('click', async () => {
            try {
                await auth.signOut();
            } catch (error) {
                console.error(error);
            }
        });

        // 로그인 상태 변경 감지
        auth.onAuthStateChanged((user) => {
            if (user && user.email === 'evolvekorea@gmail.com') {
                loginButton.style.display = 'none';
                logoutButton.style.display = 'block';
                writePostDiv.style.display = 'block';
                loadPosts();
            } else {
                loginButton.style.display = 'block';
                logoutButton.style.display = 'none';
                writePostDiv.style.display = 'none';
                postsContainer.innerHTML = '';
            }
        });

        // 게시글 작성 기능
        submitPostButton.addEventListener('click', async () => {
            const title = document.getElementById('post-title').value.trim();
            const content = document.getElementById('post-content').value.trim();
            const author = auth.currentUser ? auth.currentUser.email : 'Anonymous';
            const timestamp = firebase.firestore.FieldValue.serverTimestamp();

            if (title && content) {
                try {
                    await db.collection('one').add({
                        author,
                        content,
                        likes: 0,
                        timestamp,
                        title
                    });
                    alert('게시글이 작성되었습니다.');
                    document.getElementById('post-title').value = '';
                    document.getElementById('post-content').value = '';
                    loadPosts();
                } catch (error) {
                    console.error('게시글 작성 오류:', error);
                }
            } else {
                alert('제목과 내용을 입력하세요.');
            }
        });

        // 게시글 불러오기 기능
        async function loadPosts() {
            postsContainer.innerHTML = '';
            try {
                const querySnapshot = await db.collection('one').orderBy('timestamp', 'desc').get();
                querySnapshot.forEach((doc) => {
                    const post = doc.data();
                    const postDiv = document.createElement('div');
                    postDiv.classList.add('post');
                    postDiv.innerHTML = `
                        <h3>${post.title}</h3>
                        <p>${post.content}</p>
                        <small>작성자: ${post.author} | 좋아요: ${post.likes} | ${post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleString() : '시간 정보 없음'}</small>
                        ${auth.currentUser && auth.currentUser.email === 'evolvekorea@gmail.com' ? `<button onclick="deletePost('${doc.id}')">삭제</button>` : ''}
                    `;
                    postsContainer.appendChild(postDiv);
                });
            } catch (error) {
                console.error('게시글 불러오기 오류:', error);
            }
        }

        // 게시글 삭제 기능
        async function deletePost(postId) {
            if (confirm('이 게시글을 삭제하시겠습니까?')) {
                try {
                    await db.collection('one').doc(postId).delete();
                    alert('게시글이 삭제되었습니다.');
                    loadPosts();
                } catch (error) {
                    console.error('게시글 삭제 오류:', error);
                }
            }
        }
    </script>
</body>
</html>
