<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SurvivalOffice 블로그형 게시판 - ONE</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body>
    <h1>블로그형 게시판 - ONE</h1>
    <button id="login-btn">Google 로그인</button>
    <button id="logout-btn" style="display:none;">로그아웃</button>
    <div id="write-post" style="display:none;">
        <h2>글 작성하기</h2>
        <input type="text" id="post-title" placeholder="제목"><br>
        <div id="editor-container" style="height: 200px;"></div><br>
        <input type="file" id="image-upload" accept="image/*"><br><br>
        <button id="submit-post">게시글 작성</button>
    </div>
    <div id="posts-container"></div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script type="module">
        // Firebase SDK 모듈 가져오기
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

        // Firebase 초기화
        const firebaseConfig = {
            apiKey: "AIzaSyBU64Ad2ywQ2rTPFk4Do-PjApjLGXaiX3w",
            authDomain: "survivaloffice-blog.firebaseapp.com",
            projectId: "survivaloffice-blog",
            storageBucket: "survivaloffice-blog.appspot.com",
            messagingSenderId: "260169940492",
            appId: "1:260169940492:web:00ffac5d2600658b85b829"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const provider = new GoogleAuthProvider();
        const loginButton = document.getElementById('login-btn');
        const logoutButton = document.getElementById('logout-btn');
        const writePostDiv = document.getElementById('write-post');
        const postsContainer = document.getElementById('posts-container');
        const submitPostButton = document.getElementById('submit-post');
        const imageUploadInput = document.getElementById('image-upload');

        // Quill 에디터 초기화
        const quill = new Quill('#editor-container', {
            theme: 'snow'
        });

        // 로그인 기능
        loginButton.addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                if (result.user.email !== 'evolvekorea@gmail.com') {
                    alert('허용되지 않은 사용자입니다.');
                    await signOut(auth);
                } else {
                    alert('로그인 성공');
                }
            } catch (error) {
                console.error('로그인 오류:', error);
                alert(`로그인 실패: ${error.message}`);
            }
        });

        // 로그아웃 기능
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                alert('로그아웃 성공');
            } catch (error) {
                console.error('로그아웃 오류:', error);
                alert(`로그아웃 실패: ${error.message}`);
            }
        });

        // 로그인 상태 변경 감지
        onAuthStateChanged(auth, (user) => {
            if (user && user.email === 'evolvekorea@gmail.com') {
                loginButton.style.display = 'none';
                logoutButton.style.display = 'block';
                writePostDiv.style.display = 'block';
            } else {
                loginButton.style.display = 'block';
                logoutButton.style.display = 'none';
                writePostDiv.style.display = 'none';
            }
            loadPosts();
        });

        // 이미지 업로드 및 게시글 작성 기능
        submitPostButton.addEventListener('click', async () => {
            const title = document.getElementById('post-title').value.trim();
            const content = quill.root.innerHTML.trim(); // Quill에서 작성한 HTML 내용 가져오기
            const author = auth.currentUser ? auth.currentUser.email : 'Anonymous';
            const timestamp = serverTimestamp();

            // 이미지 파일이 선택된 경우 처리
            if (imageUploadInput.files.length > 0) {
                const file = imageUploadInput.files[0];
                const storageRef = ref(storage, `one/${Date.now()}_${file.name}`); // 'one' 폴더에 고유한 이름으로 저장

                try {
                    // Firebase Storage에 이미지 업로드
                    await uploadBytes(storageRef, file);
                    // 업로드된 이미지의 다운로드 URL 가져오기
                    const imageUrl = await getDownloadURL(storageRef);

                    // Quill 에디터 내용에 이미지 추가
                    quill.insertEmbed(quill.getLength(), 'image', imageUrl);

                    // Firestore에 게시글 저장
                    await addDoc(collection(db, 'one'), {
                        author,
                        content: quill.root.innerHTML,
                        likes: 0,
                        timestamp,
                        title
                    });

                    alert('게시글이 작성되었습니다.');
                    document.getElementById('post-title').value = '';
                    quill.root.innerHTML = ''; // 에디터 내용 비우기
                    imageUploadInput.value = ''; // 이미지 선택 비우기
                    loadPosts();
                } catch (error) {
                    console.error('이미지 업로드 및 게시글 작성 오류:', error);
                    alert(`게시글 작성 실패: ${error.message}`);
                }
            } else {
                // 이미지가 없을 경우 게시글만 저장
                if (title && content) {
                    try {
                        await addDoc(collection(db, 'one'), {
                            author,
                            content,
                            likes: 0,
                            timestamp,
                            title
                        });
                        alert('게시글이 작성되었습니다.');
                        document.getElementById('post-title').value = '';
                        quill.root.innerHTML = ''; // 에디터 내용 비우기
                        loadPosts();
                    } catch (error) {
                        console.error('게시글 작성 오류:', error);
                        alert(`게시글 작성 실패: ${error.message}`);
                    }
                } else {
                    alert('제목과 내용을 입력하세요.');
                }
            }
        });

        // 게시글 불러오기 기능
        async function loadPosts() {
            postsContainer.innerHTML = '';
            try {
                const q = query(collection(db, 'one'), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    console.log('불러올 게시글이 없습니다.');
                    postsContainer.innerHTML = '<p>게시글이 없습니다.</p>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const post = doc.data();
                        console.log('불러온 게시글:', post); // 데이터 확인용 콘솔 로그
                        const postDiv = document.createElement('div');
                        postDiv.classList.add('post');

                        let timestamp = '시간 정보 없음';
                        if (post.timestamp && post.timestamp.toDate) {
                            timestamp = post.timestamp.toDate().toLocaleString();
                        }

                        postDiv.innerHTML = `
                            <h3>${post.title}</h3>
                            <div>${post.content}</div>
                            <small>작성자: ${post.author} | 좋아요: ${post.likes} | ${timestamp}</small>
                            ${auth.currentUser && auth.currentUser.email === 'evolvekorea@gmail.com' ? `<button onclick="deletePost('${doc.id}')">삭제</button>` : ''}
                        `;
                        postsContainer.appendChild(postDiv);
                    });
                }
            } catch (error) {
                console.error('게시글 불러오기 오류:', error);
                alert(`게시글 불러오기 실패: ${error.message}`);
            }
        }

        // 게시글 삭제 기능
        window.deletePost = async function (postId) {
            if (confirm('이 게시글을 삭제하시겠습니까?')) {
                try {
                    await deleteDoc(doc(db, 'one', postId));
                    alert('게시글이 삭제되었습니다.');
                    loadPosts();
                } catch (error) {
                    console.error('게시글 삭제 오류:', error);
                    alert(`게시글 삭제 실패: ${error.message}`);
                }
            }
        }
    </script>
</body>
</html>
